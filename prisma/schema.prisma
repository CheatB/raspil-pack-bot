datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            BigInt     @id @map("tg_user_id")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  status        String     @default("FREE") // FREE, PRO, MAX, ADMIN
  paidUntil     DateTime?
  username      String?    @unique
  referralCode  String?    @unique // Уникальный реферальный код пользователя
  referralBonus Int        @default(0) // Накопленные бонусы (300 = 1 месяц Pro)
  Quota         Quota[]
  Pack          Pack[]
  Payment       Payment[]
  ReferralsAsReferrer Referral[] @relation("Referrer")
  ReferralsAsReferred Referral?  @relation("Referred")
}

model Quota {
  id        String   @id @default(cuid())
  userId    BigInt
  period    String   // YYYYMM
  imagesUsed Int     @default(0)
  videosUsed Int     @default(0)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@map("quotas")
}

model Pack {
  id         String   @id @default(cuid())
  userId     BigInt
  kind       String   @default("STATIC")
  gridRows   Int
  gridCols   Int
  padding    Int
  tilesCount Int      @default(0)
  setName    String?
  setLink    String?
  status     String   @default("PROCESSING")
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("packs")
}

model Payment {
  id        String   @id @default(cuid())
  userId    BigInt
  plan      String   // PRO, MAX
  termDays  Int
  amount    Int
  currency  String   @default("RUB")
  status    String   @default("CREATED") // CREATED, PAID, FAILED
  invoiceId String?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Event {
  id        String   @id @default(cuid())
  userId    BigInt
  type      String
  payload   String   @default("{}") // SQLite doesn't support Json, use String
  createdAt DateTime @default(now())

  @@map("events")
}

model Referral {
  id         String   @id @default(cuid())
  referrerId BigInt   // Кто пригласил
  referredId BigInt   @unique // Кого пригласили (уникально, один пользователь может быть приглашен только один раз)
  bonusGiven Boolean  @default(false) // Был ли начислен бонус рефереру
  createdAt  DateTime @default(now())

  referrer   User     @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred   User     @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@map("referrals")
}
