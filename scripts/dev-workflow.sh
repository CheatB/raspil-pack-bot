#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
# –∏–∑–º–µ–Ω–µ–Ω–∏—è -> –ø—Ä–æ–≤–µ—Ä–∫–∞ -> push -> –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ -> –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

set -e

PROJECT_ROOT="/var/www/projects/emoji_bot"
cd "$PROJECT_ROOT"

echo "üîÑ Dev workflow: –∏–∑–º–µ–Ω–µ–Ω–∏—è -> –ø—Ä–æ–≤–µ—Ä–∫–∞ -> push -> –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ -> –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üìã –ü—Ä–æ–≤–µ—Ä—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
if [ -z "$(git status --porcelain)" ]; then
    echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
    exit 0
fi

git status --short

# 2. –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
    exit 1
fi

# 3. –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì¶ –î–æ–±–∞–≤–ª—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
git add -A

# 4. –ö–æ–º–º–∏—Ç
echo "üíæ –°–æ–∑–¥–∞—é –∫–æ–º–º–∏—Ç..."
read -p "–°–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: " commit_message
if [ -z "$commit_message" ]; then
    commit_message="Update: $(date +%Y-%m-%d\ %H:%M:%S)"
fi

git commit -m "$commit_message"

# 5. Push
echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ git..."
git push origin main

# 6. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç..."
pnpm -C apps/tg-bot build:prod
NODE_OPTIONS='--max-old-space-size=1536' pnpm -C apps/web build

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 restart emoji_bot_web
pm2 restart emoji_bot

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã."
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:"
pm2 list

